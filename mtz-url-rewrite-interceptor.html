<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="mtz-interceptor-behavior.html">

<!--
`mtz-url-rewrite-interceptor`
An implementation of the mtz.InterceptorBehavior that injects a header:value onto a presend event for iron-ajax.

@demo demo/index.html
-->
<dom-module id="mtz-url-rewrite-interceptor">
  <script>
    Polymer({
      is: 'mtz-url-rewrite-interceptor',
      behaviors: [mtz.InterceptorBehavior],
      properties: {
        /* The events to intercept against */
        events: {
          type: Array,
          value() {
            return [
              {
                name: 'iron-ajax-presend',
                path: 'detail.options.url',
              },
            ];
          },
        },
        /*  */
        rewriteMatcher: {
          type: String,
          value: '/',
        },
        /* TODO: */
        baseUrl: String, // https://d-servicecenter-api.com/
        /* TODO: */
        localBaseUrl: String, // https://d-servicecenter-api.com/
        /* TODO: */
        queryParams: Object,
        /* TODO: */
        pattern: String,
        /* TODO: */
        replacement: String,
        /* TODO: */
        _localPattern: {
          type: String,
          value: 'localhost|127\\.0\\.0\\.1',
        },
        /* TODO: */
        __isLocal: {
          type: Boolean,
          readOnly: true,
          computed: '__computeIsLocal(_localPattern, __host)',
        },
        /* Stores the host for determining isLocal */
        __host: {
          type: String,
          readOnly: true,
          value() {
            return location.host;
          },
        },
      },
      /**
       * Sets the isLocal property based on if the host matches the localPattern
       *
       * @param {String|RegExp} localPattern
       * @param {String} [host=window.location.host]
       * @return {Boolean}
       */
      __computeIsLocal(localPattern, host = location.host) {
        return new RegExp(localPattern).test(host);
      },
      /**
       * Triggers the logic to rewrite the request url.
       *
       * @param {CustomEvent} event
       * @param {String} eventName
       */
      intercept(event, eventName) {
        const path = (this.events.find((item) => item.name === eventName) || {}).path;
        const reqUrl = path && this.get(path, event);
        if (reqUrl && reqUrl.startsWith(this.rewriteMatcher)) {
          this.set(reqUrl, this._rewriteUrl(reqUrl), event);
        }
      },
      /**
       * Rewrites the request url.
       * @protected
       *
       * @param {String} url
       * @param {String|RegExp} [pattern=this.pattern]
       * @param {String|Function} [replacement=this.replacement]
       * @return {String}
       */
      _rewriteUrl(url, pattern = this.pattern, replacement = this.replacement, host = this.__host, isLocal = this.__isLocal) {
        // Determine baseUrl
        const baseUrl = isLocal ?
          this.localBaseUrl :
          (this.baseUrl || host.replace(new RegExp(pattern), replacement));

        // Build our Query String
        let queryString = this.__getQueryString();
        if (queryString) {
          const bindingChar = url.indexOf('?') >= 0 ? '&' : '?';
          queryString = `${bindingChar}${queryString}`;
        }

        // Ensure the URL starts with /
        url = url.split(this.rewriteMatcher).slice(1).join(this.rewriteMatcher);
        url = `${url.startsWith('/') ? '' : '/'}${url}`;

        // Return rewritten url
        return `${baseUrl}${url}${queryString ? queryString : ''}`;
      },
      /**
       * Generates the query string from the query params object
       *
       * @param {Object} [params=this.queryParams]
       * @return {String}
       */
      __getQueryString(params = this.queryParams) {
        const queryParts = [];
        let value;
        Object.keys(params || {}).forEach((param) => {
          value = params[param];
          value = typeof value === 'function' ? value(this.__isLocal, this.__host) : value;

          param = window.encodeURIComponent(param);
          if (Array.isArray(value)) {
            for (let i = 0; i < value.length; i++) {
              queryParts.push(param + '=' + window.encodeURIComponent(value[i]));
            }
          } else if (value !== null) {
            queryParts.push(param + '=' + window.encodeURIComponent(value));
          } else if (value === null) {
            queryParts.push(param);
          }
        });
        return queryParts.join('&');
      },
    });
  </script>
</dom-module>
